{
  "name": "Restart zam√≥wie≈Ñ wg filtru",
  "description": "Og√≥lny restart zam√≥wie≈Ñ z konfigurowalnymi warunkami",
  "version": "1.0",
  "author": "System APS",
  "priority": 60,
  "cooldown": 300,
  "trigger": {
    "type": "time_based",
    "description": "Restart zam√≥wie≈Ñ co godzinƒô dla statusu pending z b≈Çƒôdami",
    "conditions": {
      "time": {
        "hour": "*/1",
        "minute": "0"
      },
      "database_list": {
        "component": "main_database",
        "table": "aps_order",
        "columns": [
          "id", "aps_id", "origin", "status", "pickup_number",
          "kds_order_number", "client_phone_number", "estimated_time", 
          "transaction_id", "marketing_consent", "terms_accepted", 
          "privacy_accepted", "promo_consent", "created_at"
        ],
        "where": {
          "status": "error",
          "created_at": "> NOW() - INTERVAL '1 hour'"
        },
        "result_key": "zamowienia_restart",
        "limit": 100,
        "order_by": "created_at ASC"
      }
    }
  },
  "actions": [
    {
      "type": "logic_and",
      "conditions": [
        {
          "type": "database_list",
          "component": "main_database",
          "table": "aps_order",
          "where": "LENGTH({{ trigger.zamowienia_restart }}) > 0",
          "result_key": "has_orders_to_restart"
        }
      ],
      "true_actions": [
        {
          "type": "log_event",
          "level": "info",
          "message": "üîÑ Rozpoczynam restart {{ trigger.zamowienia_restart|length }} zam√≥wie≈Ñ ze statusem error",
          "description": "Rozpoczƒôcie procesu restartu zam√≥wie≈Ñ"
        },
        {
          "type": "restart_orders",
          "component": "main_database",
          "orders_source": "{{ trigger.zamowienia_restart }}",
          "clone_config": {
            "copy_fields": [
              "aps_id", "origin", "kds_order_number", "client_phone_number",
              "estimated_time", "transaction_id", "marketing_consent", 
              "terms_accepted", "privacy_accepted", "promo_consent"
            ],
            "skip_fields": [],
            "default_values": {
              "pickup_number": null
            }
          },
          "description": "Restart zam√≥wie≈Ñ z b≈Çƒôdami"
        },
        {
          "type": "log_event",
          "level": "success",
          "message": "‚úÖ Restart zam√≥wie≈Ñ zako≈Ñczony. Sklonowanych: {{ action_result.success_count }}, Refund: {{ action_result.refund_count }}, B≈Çƒôdy: {{ action_result.error_count }}",
          "description": "Podsumowanie restartu zam√≥wie≈Ñ"
        }
      ],
      "false_actions": [
        {
          "type": "log_event",
          "level": "debug",
          "message": "‚ÑπÔ∏è Brak zam√≥wie≈Ñ do restartu",
          "description": "Brak zam√≥wie≈Ñ wymagajƒÖcych restartu"
        }
      ]
    }
  ]
}
