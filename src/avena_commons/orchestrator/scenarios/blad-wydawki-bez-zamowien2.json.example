{
  "name": "B≈ÇƒÖd wydawki bez zam√≥wie≈Ñ",
  "description": "Scenariusz wy≈ÇƒÖczajƒÖcy wydawkƒô przy wykryciu b≈Çƒôdu, kt√≥regokolwiek z urzƒÖdze≈Ñ wydawki, ale bez zam√≥wie≈Ñ do zresetowania.",
  "version": "1.0",
  "author": "System",
  "priority": 20,
  "cooldown": 0,
  "trigger": {
    "type": "automatic",
    "description": "Uruchomienie gdy kt√≥rekolwiek urzƒÖdzenie Wydawki jest w b≈Çƒôdzie i wydawka nie przetwarza zam√≥wienia",
    "conditions": {
      "or": {
        "conditions": [
          "virtual_device_error": {
            "client": "io",
            "device_pattern": "feeder",
            "extract_id_to": "wydawka_id",
            "extract_physical_device_to": "urzadzenie_fizyczne",
            "extract_error_message_to": "komunikat_bledu",
            "extract_device_type_to": "typ_urzadzenia"
          },
          "virtual_device_error": {
            "client": "io",
            "device_pattern": "wydawka",
            "extract_id_to": "wydawka_id",
            "extract_physical_device_to": "urzadzenie_fizyczne",
            "extract_error_message_to": "komunikat_bledu",
            "extract_device_type_to": "typ_urzadzenia"
          },
          "virtual_device_error": {
            "client": "io",
            "device_pattern": "chamber",
            "extract_id_to": "wydawka_id",
            "extract_physical_device_to": "urzadzenie_fizyczne",
            "extract_error_message_to": "komunikat_bledu",
            "extract_device_type_to": "typ_urzadzenia"
          }
        ]
      }
    }
  },
  "actions": [
    {
      "type": "log_event",
      "level": "debug",
      "message": "üîÑ FAZA 1: Zatrzymanie soft stop wszystkich element√≥w systemu.",
      "description": "Rozpoczƒôcie fazy inicjalizacji"
    },
    {
      "type": "send_command",
      "client": [
        "camera_1",
        "camera_2",
        "supervisor_1",
        "supervisor_2",
        "munchies_algo"
      ],
      "command": "CMD_INITIALIZED",
      "description": "Soft stopping urzƒÖdze≈Ñ. Wys≈Çanie CMD_INITIALIZED do wszystkich klient√≥w poza IO"
    },
    {
      "type": "log_event",
      "level": "info",
      "message": "Potwierdzenie b≈Çƒôdu na IO",
      "description": "Informacja o potwierdzeniu b≈Çƒôdu na IO"
    },
    {
      "type": "send_command",
      "client": "io",
      "command": "CMD_ACK"
    },
    {
      "type": "wait_for_state",
      "client": "io",
      "target_state": [
        "STOPPED"
      ],
      "timeout": "10s"
    },
    {
      "type": "send_command",
      "client": "io",
      "command": "CMD_INITIALIZED"
    },
    {
      "type": "wait_for_state",
      "target": "@all",
      "target_states": [
        "INITIALIZED",
        "PAUSE",
        "RUN"
      ],
      "timeout": "10s",
      "description": "Oczekiwanie na przej≈õcie klient√≥w STOPPED do INITIALIZED"
    },
    {
      "type": "log_event",
      "level": "debug",
      "message": "‚úÖ FAZA 1 ZAKO≈ÉCZONA: IO przesz≈Ço ze stanu STOPPED do INITIALIZED; reszta systemu SOFT STOP ‚Üí INITIALIZED",
      "description": "Potwierdzenie zako≈Ñczenia fazy inicjalizacji"
    },
    {
      "type": "log_event",
      "level": "info",
      "message": "Wykryto b≈ÇƒÖd na urzƒÖdzeniu wydawki {{wydawka_id}}: {{urzadzenie_fizyczne}} ({{typ_urzadzenia}}) - {{komunikat_bledu}}",
      "description": "Informacja o b≈Çƒôdzie wydawki z szczeg√≥≈Çami urzƒÖdzenia fizycznego"
    },
    {
      "type": "send_custom_command",
      "client": "munchies_algo",
      "command": "change_wydawka_state",
      "data": {
        "wydawka_id": "{{wydawka_id}}",
        "aktywna": false
      },
      "timeout": "10s",
      "description": "Wy≈ÇƒÖczenie wydawki w munchies_algo"
    },
    {
      "type": "log_event",
      "level": "info",
      "message": "Wydawka zosta≈Ça wy≈ÇƒÖczona z powodu wykrycia b≈Çƒôdu w urzƒÖdzeniu",
      "description": "Informacja o wy≈ÇƒÖczeniu wydawki"
    },
    {
      "type": "log_event",
      "level": "debug",
      "message": "üöÄ FAZA 2: Uruchomienie wszystkich klient√≥w ‚Üí RUN",
      "description": "Rozpoczƒôcie fazy uruchomienia"
    },
    {
      "type": "send_command",
      "target": "@all",
      "command": "CMD_RUN",
      "description": "#TODO: CZY POWINNI≈öMY WYSY≈ÅAƒÜ CMD_RUN DO WSZYSTKICH? Wys≈Çanie CMD_RUN do IO (INITIALIZED‚ÜíRUN, PAUSE‚ÜíRUN)"
    },
    {
      "type": "wait_for_state",
      "target": "@all",
      "target_state": "RUN",
      "timeout": "10s",
      "description": "Oczekiwanie na przej≈õcie wszystkich klient√≥w do stanu RUN"
    },
    {
      "type": "log_event",
      "level": "debug",
      "message": "‚ú® Manualny start systemu zako≈Ñczony - wszystkie klienty przygotowane do operacji",
      "description": "Ostateczne potwierdzenie zako≈Ñczenia procedury"
    },
    {
      "type": "log_event",
      "level": "info",
      "message": "Wszystkie serwisy zosta≈Çy wznowione",
      "description": "Informacja o wznowieniu wszystkich serwis√≥w"
    },
    {
      "type": "send_email",
      "to": [
        "damian.gawin@pomagier.info",
        "lukasz.lecki@pomagier.info",
        "mikolaj.galant@pomagier.info",
        "kamil.ochal@pomagier.info"
      ],
      "subject": "B≈ÇƒÖd wydawki {{wydawka_id}} - {{typ_urzadzenia}}",
      "body": "Wykryto b≈ÇƒÖd na wydawce {{wydawka_id}}.\n\nUrzƒÖdzenie fizyczne: {{urzadzenie_fizyczne}} ({{typ_urzadzenia}})\nKomunikat b≈Çƒôdu: {{komunikat_bledu}}\n\nBrak zam√≥wie≈Ñ do zresetowania na tej wydawce.\n\nProszƒô o sprawdzenie i naprawƒô urzƒÖdzenia.",
      "description": "Powiadomienie email o b≈Çƒôdzie wydawki"
    },
    {
      "type": "send_custom_command",
      "client": "aps_kds",
      "command": "order_update",
      "data": {
        "order_number": null,
        "pickup_number": "{{wydawka_id}}",
        "next_order_number": null,
        "message": null
      },
      "timeout": "2s",
      "description": "Czyszczenie zam√≥wie≈Ñ na wy≈ÇƒÖczonej wydawce w APS KDS"
    }
  ]
}